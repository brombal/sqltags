{"mappings":";;AAGA,6BAA6B,MAAM,EAAE,QAAQ,GAAG,kBAAkB,SAAS,CAAC,CA4E3E","sources":["drivers/sqlite/sqlite.ts"],"sourcesContent":["import { type SqlTemplateDriver } from '@sqltags/core';\nimport { type Database } from 'sqlite3';\n\nexport function sqliteDriver(client: Database): SqlTemplateDriver<undefined> {\n  return {\n    parameterizeValue(_value: any, _paramIndex: number) {\n      return `?`;\n    },\n\n    escapeIdentifier(identifier: string) {\n      return '\"' + identifier.replace(/\"/g, '\"\"') + '\"';\n    },\n\n    query: async (sql: string, params: any[]): Promise<[any[], undefined]> => {\n      const res: any[] = await new Promise((resolve, reject) => {\n        client.all(sql, params, (err, rows: any[]) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(rows);\n          }\n        });\n      });\n      return [res, undefined];\n    },\n\n    cursor: function (sql: string, params: any[]): AsyncIterable<any> {\n      let started = false;\n      let resolver: ((value: any) => void) | undefined;\n      let rejecter: ((value: any) => void) | undefined;\n      const queue = [] as any[];\n      return {\n        [Symbol.asyncIterator]: () => ({\n          next: async () => {\n            if (!started) {\n              client.each(\n                sql,\n                params,\n                (err, row) => {\n                  // There is no case I could find where this would be called with an error, but the docs say it might\n                  // istanbul ignore if\n                  if (err) {\n                    rejecter!(err);\n                  } else {\n                    queue.push(row);\n                    resolver!(row);\n                  }\n                },\n                (err) => {\n                  if (err) rejecter!(err);\n                  else {\n                    queue.push(undefined);\n                    resolver!(undefined);\n                  }\n                  rejecter = undefined;\n                  resolver = undefined;\n                },\n              );\n              started = true;\n            }\n\n            if (!queue.length) {\n              await new Promise((resolve, reject) => {\n                resolver = resolve;\n                rejecter = reject;\n              });\n            }\n\n            if (queue.length > 0) {\n              const row = queue.shift();\n              if (row !== undefined) return { done: false, value: row };\n            }\n\n            return { done: true, value: undefined };\n          },\n        }),\n      };\n    },\n  };\n}\n"],"names":[],"version":3,"file":"index.d.ts.map","sourceRoot":"../../../"}